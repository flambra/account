version: v1.0
name: Deploy Pipeline

agent:
  machine:
    type: s1-server-1
blocks:
  - name: Load Configs
    task:
      jobs:
        - name: Load .env File
          commands:
            - echo $SEMAPHORE_GIT_REPO_NAME
            - echo "Loading .env file"
            - cd ~/projects/configs
            - git pull
            - cp $SEMAPHORE_GIT_REPO_NAME/staging/.env ~/projects/$SEMAPHORE_GIT_REPO_NAME/.env

  - name: Remove Old Docker Containers and Images
    task:
      jobs:
        - name: Docker Cleanup
          commands:
            - echo "Removing old Docker containers and images for $SEMAPHORE_GIT_REPO_NAME"
            - docker rm -f $(docker ps -a -q -f ancestor=$SEMAPHORE_GIT_REPO_NAME:latest) | true
            - docker rmi $(docker images -q $SEMAPHORE_GIT_REPO_NAME) | true
            - docker image prune -a -f

  - name: Build Docker Image
    task:
      jobs:
        - name: Docker Build
          commands:
            - echo "Building Docker Image"
            - cd ~/projects/$SEMAPHORE_GIT_REPO_NAME
            - git pull
            - docker build -t $SEMAPHORE_GIT_REPO_NAME:latest .

  - name: Run Docker Container
    task:
      jobs:
        - name: Docker Run
          commands:
            - echo "Running Docker Container"
            - docker run -d -p 8081:8081 --name $SEMAPHORE_GIT_REPO_NAME $SEMAPHORE_GIT_REPO_NAME:latest
            - sleep 10
            - echo "Checking Health of the Application"
            - curl -f https://$SEMAPHORE_GIT_REPO_NAME.flambra.com || (echo -e "\e[31mHealth check failed\e[0m" && exit 1)
            - echo "Fetching Docker Logs"
            - docker logs $SEMAPHORE_GIT_REPO_NAME | tee docker.log
            - echo "Highlighting Errors in Docker Logs"
            - grep -i "error" docker.log | sed 's/^/\x1b[31m/' | sed 's/$/\x1b[0m/'