version: v1.0
name: Deploy Pipeline

agent:
  machine:
    type: s1-server-1
blocks:
  - name: Load Configs
    task:
      jobs:
        - name: Load .env File
          commands:
            - echo $SEMAPHORE_GIT_REPO_NAME
            - echo "Loading .env file"
            - cd ~/projects/configs
            - git pull
            - cp $SEMAPHORE_GIT_REPO_NAME/staging/.env ~/projects/$SEMAPHORE_GIT_REPO_NAME/.env

  - name: Build Docker Image
    task:
      jobs:
        - name: Docker Build
          commands:
            - echo $SEMAPHORE_GIT_COMMIT_RANGE
            - echo $SEMAPHORE_GIT_COMMITTER
            - echo "Building Docker Image"
            - cd ~/projects/$SEMAPHORE_GIT_REPO_NAME
            - git pull
            - docker build -t $SEMAPHORE_GIT_REPO_NAME:latest .

  - name: Run Docker Container
    task:
      jobs:
        - name: Docker Run
          commands:
            - echo "Running Docker Container"
            - docker run -d --name $SEMAPHORE_GIT_REPO_NAME -p 8081:8081 $SEMAPHORE_GIT_REPO_NAME:latest

  - name: Health Check
    task:
      jobs:
        - name: Check Application Health
          commands:
            - echo "Checking Health of the Application"
            - sleep 10 # Wait for the application to start
            - curl -f http://localhost:8081/home || (echo "Health check failed" && exit 1)