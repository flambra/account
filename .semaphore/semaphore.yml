version: v1.0
name: Deploy Pipeline

agent:
  machine:
    type: s1-server-2
blocks:
  - name: Load Configs
    task:
      jobs:
        - name: Load .env File
          commands:
            - echo $ID_RSA_PRIVATE > ~/.ssh/id_rsa
            - echo "Loading .env file"
            - cd ~/projects/configs
            - git pull
            - cp account/staging/.env ~/projects/account/.env

  - name: Build Docker Image
    task:
      jobs:
        - name: Docker Build
          commands:
            - echo $ID_RSA_PRIVATE > ~/.ssh/id_rsa
            - echo "Building Docker Image"
            - git pull
            - docker build -t myapp:latest .

  - name: Run Docker Container
    task:
      jobs:
        - name: Docker Run
          commands:
            - echo $ID_RSA_PRIVATE > ~/.ssh/id_rsa
            - echo "Running Docker Container"
            - docker run -d --name myapp-container -p 8081:8081 myapp:latest

  - name: Health Check
    task:
      jobs:
        - name: Check Application Health
          commands:
            - echo "Checking Health of the Application"
            - sleep 10 # Wait for the application to start
            - curl -f http://localhost:8081/home || (echo "Health check failed" && exit 1)